#!/bin/bash

# Pre-commit hook pour d√©tecter les secrets dans KiloShare
# Pour l'activer: ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit

# Couleurs
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üîç V√©rification des secrets avant commit..."

# Patterns de secrets √† d√©tecter
SECRET_PATTERNS=(
    "sk_live_[a-zA-Z0-9]+"                           # Stripe Live Secret Key
    "sk_test_[a-zA-Z0-9]+"                           # Stripe Test Secret Key
    "pk_live_[a-zA-Z0-9]+"                           # Stripe Live Publishable Key
    "pk_test_[a-zA-Z0-9]+"                           # Stripe Test Publishable Key
    "whsec_[a-zA-Z0-9]+"                             # Stripe Webhook Secret
    "password\s*=\s*['\"][^'\"]{8,}['\"]"            # Hard-coded passwords
    "secret\s*=\s*['\"][^'\"]{8,}['\"]"              # Hard-coded secrets
    "token\s*=\s*['\"][^'\"]{16,}['\"]"              # Hard-coded tokens
    "api_key\s*=\s*['\"][^'\"]{16,}['\"]"            # API Keys
    "AKIA[0-9A-Z]{16}"                               # AWS Access Key
)

# Fichiers √† exclure de la v√©rification
EXCLUDE_PATTERNS=(
    "vendor/"
    "node_modules/"
    ".git/"
    "*.log"
    "*.example"
    "*.template"
    ".env.example"
    "SECURITY.md"
    "EMERGENCY_SECURITY.md"
    "README_SECURITY.md"
    ".githooks/"
    "scripts/security-check.sh"
)

FOUND_SECRETS=0

# Obtenir la liste des fichiers modifi√©s
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    echo -e "${GREEN}‚úÖ Aucun fichier √† v√©rifier${NC}"
    exit 0
fi

echo "Fichiers √† v√©rifier: $(echo $FILES | wc -w)"

for file in $FILES; do
    # V√©rifier si le fichier existe (peut √™tre supprim√©)
    if [ ! -f "$file" ]; then
        continue
    fi

    # V√©rifier si le fichier doit √™tre exclu
    SKIP_FILE=false
    for exclude in "${EXCLUDE_PATTERNS[@]}"; do
        if [[ "$file" == *"$exclude"* ]]; then
            SKIP_FILE=true
            break
        fi
    done

    if [ "$SKIP_FILE" = true ]; then
        continue
    fi

    # V√©rifier chaque pattern de secret
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -qE "$pattern" "$file"; then
            echo -e "${RED}üö® SECRET D√âTECT√â dans $file${NC}"
            echo -e "${YELLOW}Pattern: $pattern${NC}"
            grep -nE "$pattern" "$file" | head -3
            echo ""
            FOUND_SECRETS=$((FOUND_SECRETS + 1))
        fi
    done

    # V√©rification sp√©ciale pour les cl√©s priv√©es (sans utiliser grep -E avec tirets)
    if grep -q "BEGIN PRIVATE KEY" "$file" || grep -q "BEGIN RSA PRIVATE KEY" "$file"; then
        echo -e "${RED}üö® CL√â PRIV√âE D√âTECT√âE dans $file${NC}"
        echo -e "${YELLOW}Pattern: Private Key${NC}"
        grep -n "BEGIN.*PRIVATE KEY" "$file" | head -1
        echo ""
        FOUND_SECRETS=$((FOUND_SECRETS + 1))
    fi
done

# V√©rifications sp√©cifiques pour les fichiers sensibles
for file in $FILES; do
    case "$file" in
        *.env)
            if [ "$file" != ".env.example" ] && [ "$file" != ".env.template" ]; then
                echo -e "${RED}üö® ATTENTION: Tentative de commit d'un fichier .env: $file${NC}"
                FOUND_SECRETS=$((FOUND_SECRETS + 1))
            fi
            ;;
        *service-account*.json)
            if [[ "$file" != *".example"* ]]; then
                echo -e "${RED}üö® ATTENTION: Tentative de commit d'un service account: $file${NC}"
                FOUND_SECRETS=$((FOUND_SECRETS + 1))
            fi
            ;;
        *.key|*.pem|*.crt)
            echo -e "${RED}üö® ATTENTION: Tentative de commit d'un certificat/cl√©: $file${NC}"
            FOUND_SECRETS=$((FOUND_SECRETS + 1))
            ;;
    esac
done

if [ $FOUND_SECRETS -gt 0 ]; then
    echo -e "${RED}‚ùå COMMIT BLOQU√â: $FOUND_SECRETS secret(s) d√©tect√©(s)${NC}"
    echo ""
    echo "üõ†Ô∏è ACTIONS √Ä EFFECTUER:"
    echo "1. Supprimez les secrets du code"
    echo "2. Utilisez des variables d'environnement"
    echo "3. Ajoutez les fichiers sensibles au .gitignore"
    echo "4. Si n√©cessaire, r√©voquez les cl√©s expos√©es"
    echo ""
    echo "üìö Voir: SECURITY.md pour les bonnes pratiques"
    echo ""
    echo "‚ö†Ô∏è Pour forcer le commit (NON RECOMMAND√â):"
    echo "git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}‚úÖ Aucun secret d√©tect√© - Commit autoris√©${NC}"
exit 0