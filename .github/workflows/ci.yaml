name: Deploy API to OVH

on:
  push:
    branches:
      - development
    paths:
      - 'api/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout le code du dÃ©pÃ´t
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurer PHP et installer les dÃ©pendances
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, openssl, curl
        if: hashFiles('./api/composer.json') != ''

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ./api/vendor
          key: composer-${{ hashFiles('./api/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies in API folder
        run: |
          if [ -f "./api/composer.json" ]; then
            cd api
            composer install --no-dev --prefer-dist --optimize-autoloader --no-scripts
            composer dump-autoload --optimize
          fi

      # 3. CrÃ©er le fichier .env de production
      - name: Create production .env file
        run: |
          cd api
          cat > .env << 'EOF'
          # Environment Configuration
          ENVIRONMENT=production
          APP_ENV=production
          APP_DEBUG=false
          APP_TIMEZONE=Europe/Paris

          # Database Configuration
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_CHARSET=utf8mb4

          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=86400

          # API Configuration par environnement
          API_BASE_URL_PROD=https://m2atodev.com/api.kiloshare
          CORS_ALLOWED_ORIGINS_PROD=https://kiloshare.com,https://www.kiloshare.com
          API_BASE_URL=https://m2atodev.com/api.kiloshare
          CORS_ALLOWED_ORIGINS=https://kiloshare.com,https://www.kiloshare.com

          # FTP Upload Configuration
          UPLOAD_PATH=uploads/
          MAX_FILE_SIZE=10485760
          ALLOWED_EXTENSIONS=jpg,jpeg,png,gif,pdf
          BASE_UPLOADS_URL=https://m2atodev.com/api.kiloshare/uploads/

          # Twilio SMS Configuration
          TWILIO_SID=${{ secrets.TWILIO_SID }}
          TWILIO_TOKEN=${{ secrets.TWILIO_TOKEN }}
          TWILIO_FROM=${{ secrets.TWILIO_FROM }}

          # Brevo API Configuration
          BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
          MAIL_FROM=noreply@kiloshare.com
          DEV_EMAIL=${{ secrets.DEV_EMAIL }}

          # Firebase FCM Configuration
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CREDENTIALS_PATH=config/firebase-service-account.json
          FCM_ENABLED=true

          # STRIPE
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLIC_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_USE_REAL_API=true

          # Cloudinary Configuration
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }}

          # Frontend Configuration par environnement
          FRONTEND_URL_PROD=https://kiloshare.com
          FRONTEND_URL=https://kiloshare.com
          EOF

      # 4. Set permissions before deploy
      - name: Prepare files for deployment
        run: |
          cd api
          chmod 644 .htaccess
          chmod 644 public/.htaccess
          chmod 600 .env
          chmod +x setup-domain.sh

      # 5. DÃ©ployer via FTP sur le serveur OVH
      - name: Deploy API to OVH via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.4
        with:
          server: ${{ secrets.KS_FTP_SERVER }}
          username: ${{ secrets.KS_FTP_USERNAME }}
          password: ${{ secrets.KS_FTP_PASSWORD }}
          local-dir: ./api/
          server-dir: /www/api.kiloshare/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/test_*.php
            **/.env.example
            **/README.md
            **/phpunit.xml
            **/.phpunit.*

      # 6. Post-deployment configuration (optionnel)
      - name: Configure server post-deployment
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸŒ API accessible at: https://m2atodev.com/api.kiloshare/"
          echo "ðŸ§ª Test with: https://m2atodev.com/api.kiloshare/check-server.php"